services:
  core-system:
    build:
      context: .
      dockerfile: packages/core-system/Dockerfile
    environment:
      CORE_SYSTEM_PORT: 3001
      SERVICE_REGISTRY_PORT: 3000
      CORE_SYSTEM_PUBLIC_URL: http://core-system:3001
      SERVICE_REGISTRY_PUBLIC_URL: http://core-system:3000
      SERVICE_REGISTRY_URL: http://core-system:3000
      KNOWLEDGE_BASE_URL: http://knowledge-base:3005
      BIND_ADDRESS: 0.0.0.0
    ports:
      - "3001:3001"
      - "3000:3000"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  knowledge-base:
    build:
      context: .
      dockerfile: packages/knowledge-base/Dockerfile
    environment:
      KNOWLEDGE_BASE_PORT: 3005
      KNOWLEDGE_BASE_PUBLIC_URL: http://knowledge-base:3005
      SERVICE_REGISTRY_URL: http://core-system:3000
      LLM_ENDPOINT: ${LLM_ENDPOINT:-http://192.168.1.73:1234/v1/chat/completions}
      LLM_MODEL: ${LLM_MODEL:-gemma 3b}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      OPENROUTER_API_URL: ${OPENROUTER_API_URL:-https://openrouter.ai/api/v1/chat/completions}
      OPENROUTER_MODEL: ${OPENROUTER_MODEL:-}
      OPENROUTER_APP_URL: ${OPENROUTER_APP_URL:-}
      OPENROUTER_APP_NAME: ${OPENROUTER_APP_NAME:-IMP Requirements KB}
      OPENROUTER_REASONING_EFFORT: ${OPENROUTER_REASONING_EFFORT:-}
      KNOWLEDGE_BASE_DATA_FILE: /data/kb-data.json
      BIND_ADDRESS: 0.0.0.0
    ports:
      - "3005:3005"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3005/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - knowledge-base-data:/data
      - ./packages/knowledge-base/logs:/app/packages/knowledge-base/logs
    depends_on:
      core-system:
        condition: service_healthy
    restart: unless-stopped

  activity-recognition:
    build:
      context: .
      dockerfile: packages/activity-recognition/Dockerfile
    environment:
      ACTIVITY_RECOGNITION_PORT: 3003
      ACTIVITY_RECOGNITION_PUBLIC_URL: http://activity-recognition:3003
      CORE_SYSTEM_URL: http://core-system:3001
      SERVICE_REGISTRY_URL: http://core-system:3000
      BIND_ADDRESS: 0.0.0.0
    ports:
      - "3003:3003"
    depends_on:
      core-system:
        condition: service_healthy
      knowledge-base:
        condition: service_healthy
    restart: unless-stopped

  device-api:
    build:
      context: .
      dockerfile: packages/device/Dockerfile
    command: ["npm", "run", "server"]
    environment:
      DEVICE_API_PORT: 3002
      DEVICE_API_PUBLIC_URL: http://device-api:3002
      CORE_SYSTEM_URL: http://core-system:3001
      SERVICE_REGISTRY_URL: http://core-system:3000
      THING_BASE_URL: http://things:3006/light-switch
      BIND_ADDRESS: 0.0.0.0
    ports:
      - "3002:3002"
    depends_on:
      core-system:
        condition: service_healthy
      knowledge-base:
        condition: service_healthy
      things:
        condition: service_healthy
    restart: unless-stopped

  device-ui:
    build:
      context: .
      dockerfile: packages/device/Dockerfile
    environment:
      VITE_CORE_WS_URL: ws://core-system:3001
      VITE_CORE_WS_FALLBACK_PORT: 3001
      BIND_ADDRESS: 0.0.0.0
    command: ["npm", "run", "dev"]
    ports:
      - "5173:5173"
    depends_on:
      core-system:
        condition: service_healthy
      knowledge-base:
        condition: service_healthy
      things:
        condition: service_healthy
    restart: unless-stopped

  tablet-device-api:
    build:
      context: .
      dockerfile: packages/tablet-device/Dockerfile
    command: ["npm", "run", "server"]
    environment:
      DEVICE_API_PORT: 3012
      DEVICE_API_PUBLIC_URL: http://tablet-device-api:3012
      CORE_SYSTEM_URL: http://core-system:3001
      SERVICE_REGISTRY_URL: http://core-system:3000
      THING_BASE_URL: http://things:3006/light-switch
      BIND_ADDRESS: 0.0.0.0
    ports:
      - "3012:3012"
    depends_on:
      core-system:
        condition: service_healthy
      knowledge-base:
        condition: service_healthy
      things:
        condition: service_healthy
    restart: unless-stopped

  tablet-device-ui:
    build:
      context: .
      dockerfile: packages/tablet-device/Dockerfile
    environment:
      VITE_CORE_WS_URL: ws://core-system:3001
      VITE_CORE_WS_FALLBACK_PORT: 3001
      VITE_DEVICE_API_URL: http://tablet-device-api:3012
      VITE_DEVICE_API_PORT: 3012
      BIND_ADDRESS: 0.0.0.0
    command: ["npm", "run", "dev"]
    ports:
      - "5174:5174"
    depends_on:
      core-system:
        condition: service_healthy
      knowledge-base:
        condition: service_healthy
      things:
        condition: service_healthy
      tablet-device-api:
        condition: service_started
    restart: unless-stopped

  things:
    build:
      context: .
      dockerfile: packages/things/Dockerfile
    environment:
      THINGS_PORT: 3006
      THINGS_PUBLIC_URL: http://things:3006
      CORE_SYSTEM_URL: http://core-system:3001
      SERVICE_REGISTRY_URL: http://core-system:3000
      BIND_ADDRESS: 0.0.0.0
    ports:
      - "3006:3006"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3006/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      core-system:
        condition: service_healthy
      knowledge-base:
        condition: service_healthy
    restart: unless-stopped

  voice-device:
    build:
      context: .
      dockerfile: packages/voice-device/Dockerfile
    environment:
      VOICE_DEVICE_PORT: 3004
      VOICE_DEVICE_PUBLIC_URL: http://voice-device:3004
      CORE_SYSTEM_URL: http://core-system:3001
      SERVICE_REGISTRY_URL: http://core-system:3000
      LIGHT_SWITCH_BASE_URL: http://things:3006/light-switch
      BIND_ADDRESS: 0.0.0.0
    ports:
      - "3004:3004"
    depends_on:
      core-system:
        condition: service_healthy
      knowledge-base:
        condition: service_healthy
      things:
        condition: service_healthy
      device-api:
        condition: service_started
    restart: unless-stopped


volumes:
  knowledge-base-data:
